 OPT UADE0C ;FILE > Uade0C
 TTL File server file UADE0C

;**********************************
;*           D I R M A N          *
;**********************************

;DIRMAN: THE DIRECTORY MANAGER.
;1) PRESERVE SIN OF AN OBJECT IN A DIR
;2) RETRVE SIN OF AN OBJ WITH GIVEN FILE TITLE
;3) DELETE - REMOVE A DIR ENTRY
;4) SETATTRIBS
;5) CREATE DIR
;6) CHANGE OBJECT SIZE
;7) EXAMINE
;8) FORMATTED DETAILS OF DIR ENTRY
;9) MAKE DIRECTORY removed ** 3/10/84 **
;10) GIVE DISC NAME FROM FILE TITLE
;11) Remove a directory ** 24/9/84 **  
;12) Preserve object (without DELCHK) ** 25/9/84 **
;13) Check if object will preserve **23/3/88**

;v1.23
DIRMAN LDXIM 12

;v1.31
;DIRMAN LDXIM 13

 LDAIM MODDIR
 JSR ENTRY
 LDAIM &19
 JSR SETFS
 JMIX DRRTNS
DRRTNS
 & DRPRES ;1 => PRESERVE OBJECT
 & DRRETR ;2 => RETRIEVE OBJECT
 & DRDELT ;3 => DELETE OBJECT
 & DRSACC ;4 => SET ATTRIBUTES
 & DRCRDR ;5 => CREATE DIRECTORY
 & DRCHSZ ;6 => CHANGE SIZE OF OBJECT
 & DREXAM ;7 => GIVE DETAILS FOR EXAMINE
 & DRINFO ;8 => DETAILS OF OBJECT(CHAR STRING FORMAT)
 & DRMAKE ;9 => MAKE A DIR (DON'T PRESERVE)
 & DRFTDN ;10 => FILE TITLE -> DISC NO.
 & DRDELT ;11 => Remove a directory
 & DRPRES ;12 => Preserve object without delchk
;v1.31
; & DRPRES ;13 => Check if object will preserve
DREXIT JMP PREXIT ;**25/12/86**

;*********** DRPRES ***********

;DRPRES: PRESERVE THE SIN OF AN OBJECT WITH A GIVEN TITLE

;ENTRY:
;ARGB-C PTR TO USERINFO
;ARGD-E PTR TO FILE TITLE
;ARGF-I LOAD ADDR
;ARGJ-M EXEC ADDR
;ARGN = TYPE AND ACCESS (TLWR/WR)
;ARGO-P DATE CREATED
;ARGQ-S SIN
;ARGT = WILD CARD FLAG

;EXIT :
;ARGA = RC
;ARGB-C DISC NO
;ARGD-E SIN OF OBJECT TO BE DELETED
;ARGG = Access byte

;N.B. IF ARGD!ARGE!ARGF = 0 THEN NO DELETE NEEDED


DRPRES ROUT
 LDYIM ARGT ;get wild card flag
 LDAIY ARGPTR
 STA DIRWC ;save flag for decoding routines
 JSR INITDV ;INIT VARIABLES
 BNE #10

;CHECK FOR OWNER ACCESS

 JSR TSTOWN
 BNE #10

;RETRIEVE APPROPRIATE DIR

 JSR RETDIR
 BNE #10

 LDYIM ARGA
 LDAIY ARGPTR ;check entry code
 EORIM 12 ;dont do DELCHK in retain
 JSR RETA12 ;special case
10 PHA ;**25/12/86**
 LDA OBJACC
 LDYIM ARGG
 STAIY ARGPTR
 PLA
 BRA DREXIT ;**25/12/86**


;************ DRRETR ************

;DRRETR: RETRIEVE DETAILS OF A SPECIFIED OBJECT

;ENTRY:
;ARGB-C PTR TO USERINFO
;ARGD-E PTR TO FILE TITLE
;ARGF-G ADDRESS OF STORE AREA TO CONTAIN DETAILS
;ARGH = Wild card flag

;EXIT: ARGA = RC
;ARGB = TYPE OF OBJECT & MAX ACCESS ALLOWED TO IT
;       Also contains "lock" bit and OWNER/PUBLIC bit

;DETAILS INCLUDE:-
;FILE TITLE (10 BYTES)
;LOAD ADDR (4BYTES),
;EXEC ADDR (4BYTES),
;ACC INFO (1 BYTE),
;CREATION DATE (2 BYTE),
;SIN (3BYTES),
;DISC NO (2BYTES),      Set after any non-syntax error ** 14/10/86 **
;SIZE (3BYTES).


DRRETR ROUT

;v1.31
; JSR DRRET2 ;**4/4/88** call as subroutine
; BRA DREXIT

;DRRET2 

 LDYIM ARGH
 LDAIY ARGPTR
 ORAIM &02 ;**2/6/87** "^" allowed at end
 STA DIRWC ;get wild card flag
 JSR INITDV
 BEQ #00
 JMP #60

00 JSR SETINF ;**08/02/87**

 LDYIM INFDIS ;in case fail later still make some details
 LDA DRDISC ;point to disc number (if any) as this is
 STAIY INFPTR ;needed by RENAME
 INY
 LDA DRDISC+1
 STAIY INFPTR ;end ** 14/10/86 **

;RETRIEVE RELEVENT DIR

 JSR TSTROT ;TEST FOR <root><terminator>
 BNE #20

;SUPPLY DETAILS OF ROOT DIR

;v1.31
; LDAIM ROOT ;**4/4/88** Set up name
; JSR OUTCH
; LDXIM 9
; JSR OUTSPS
; JSR SETINF ;Reset INFPTR

05 LDYIM INFLOA
 LDXIM 8
 LDAIM 0
10 STAIY INFPTR ;LOAD ADDRESS:=EXEC ADDR:=0
 INY
 DEX
 BNE #10

 LDA DIRACC
 LDYIM ARGB
 STAIY ARGPTR ;ACCESS TO ROOT DIR
 
;v1.23
 LDYIM INFDTE
 LDA TDATE
 STAIY INFPTR
 LDA TDATE+1
 STAIY INFPTR
 LDYIM INFACC
 LDAIM TYPDIR
 STAIY INFPTR
 LDA DIRSIN
 LDYIM INFSIN

;v1.31
; LDYIM INFACC
; LDAIM TYPDIR+LOCKED
; STAIY INFPTR
; INY
; LDA TDATE ;(DATE OF CREATION ROOT)
; STAIY INFPTR
; INY
; LDA TDATE+1
; STAIY INFPTR
; LDA DIRSIN
; INY

 STAIY INFPTR
 LDA DIRSIN+1
 INY
 STAIY INFPTR
 LDA DIRSIN+2
 INY
 STAIY INFPTR
 JSR DIROBJ ;**08/02/87** Copy DIRSIN to OBJSIN
 JSR RETDSZ ;PLACE DISC NO & SIZE IN INFPTR
 BRA #50

20 JSR TSTPAR ;**23/1/87** check if ^ for parent
 BNE #25
; JSR RETPAR ;**23/1/87** retrieve parent directory
; BNE #40
; JSR UNLOCK
21 CLC ;**20/5/87** copy name of parent directory
 LDA DIRSTA
 ADCIM DRNAME
 STA MOVFRM
 LDA DIRSTA+1
 ADCIM 0
 STA MOVFRM+1
 LDYIM NAMLNT-1
22 LDAIY MOVFRM
 STAIY INFPTR
 DEY
 BPL #22

;v1.31
; LDA DATE ;set date to today (????????)
; STA TDATE
; LDA DATE+1
; STA TDATE+1
 BRA #05 ;**23/1/87** complete info entry a la root

 [ Pseudods = Yes
25 LDYIM 1 ;**20/5/87** check lone pseudo-directory
 LDAIY NAMPTR
 CMPIM TERMIN
 BNE #27
 DEY
 LDAIY NAMPTR
 JSR Testpd
 BNE #27
 JSR LOADDR ;**20/5/87** load directory
 BNE #60

;v1.31
; LDA DATE ;set date to today (????????)
; STA TDATE
; LDA DATE+1
; STA TDATE+1
 |
25 BRA #27
 ]
26 JSR UNLOCK
 BRA #21 ;**20/5/87** go update details
 
27 LDYIM ARGH ;get flag
 LDAIY ARGPTR
 RORA
 BCC #30
 JSR RETEND ;get directory
 BRA #40
30 JSR RETENT
40 BNE #60
 JSR Tsparn ;**2/6/87** parent at end?
 BEQ #26 ;**2/6/87** yes, extract details now

;COPY DETAILS INTO STORE AREA POINTED TO BY INFPTR

 JSR DETALS
 PHA ;Push return code

;NOW CALCULATE CALLER'S ACCESS TO THE OBJECT

 JSR MAXACC

 LDYIM ARGB
 STAIY ARGPTR ;TYPE & MAX ACCESS ALLOWED TO OBJECT
 JSR UNLOCK ;STRMAN.UNLOCK (DIR)
 PLA ;Pull DETALS return code
 BNE #60 ;Error

50 LDAIM 0 ;RC:=0

;v1.23
60 JMP DREXIT

;v1.31
;60 RTS ;**4/4/88**

;MAKE INFPTR POINT TO DETAILS AREA

SETINF ROUT
 LDYIM ARGF
 LDAIY ARGPTR
 STA INFPTR
 INY
 LDAIY ARGPTR
 STA INFPTR+1
 INY
 RTS



;************ DRDELT ************


;DRDELT: DELETE

;ENTRY:
;ARGB-C PTR TO USERINFO
;ARGD-E PTR TO FILE TITLE

;EXIT :
;ARGA = RC
;ARGB-C DISC NO
;ARGD-F SIN OF OBJECT TO BE DELETED


DRDELT ROUT
 LDYIM ARGG
 LDAIY ARGPTR
 STA DIRWC ;get wild card flag
 JSR INITDV ;INIT VARIABLES
 BNE #20

;CHECK FOR OWNER ACCESS

 JSR TSTOWN
 BNE #20

;RETRIEVE APPROPRIATE DIR ENTRY

 JSR RETENT ;RETRIEVE REQ'D ENTRY
 BNE #20

;FIRST CHECK THAT ENTRY MAY BE DELETED

 LDYIM ARGA ;check entry code
 LDAIY ARGPTR ;** 24/9/84 **
 CMPIM 11
 BEQ #10 ;skip delete check if 'remove' called

 JSR DELCHK
 BEQ #10
 JSR UNLOCK
 BNE #20

;NOW REMEMBER DISC NO & SIN OF OBJECT TO BE DELETED

10 JSR CRNSIN ;OBJSIN := SIN OF CRNTEN
 JSR ARGDSN ;PLACE DISC NO & SIN ON ARGPTR STACK

;NOW UNCHAIN CURRENT DIR ENTRY & PLACE
;IT ON THE FREE CHAIN

 LDYIM DRLINK
 LDAIY CRNTEN
 STAIY PREVEN
 INY
 LDAIY CRNTEN
 STAIY PREVEN ;[PREVEN] := [CRNTEN]

 JSR FREECH ;PLACE CRNTEN ENTRY ON FREE CHAIN

;NOW DECREMENT COUNT OF NUMBER OF DIR ENTRIES

 JSR SETGEN ;GENPTR := [DIRSTA]
 SEC
 LDYIM DRENTS
 LDAIY GENPTR
 SBCIM 1
 STAIY GENPTR
 INY
 LDAIY GENPTR
 SBCIM 0
 STAIY GENPTR ;[DIRSTA + DRENTS] -:= 1

;ENSURE UPTO DATE ON DISC

 JSR ENSRIT

20 JMP DREXIT ;**25/12/86**


;************ DRSACC ************


;DRSACC: SET ATTRIBUTES

;ENTRY:
;ARGB-C PTR TO USERINFO
;ARGD-E PTR TO FILE TITLE
;ARGG = FN
;     FN = 1 => SET LOAD/EXEC & ACCESS
;     FN = 2 => SET LOAD ADDR
;     FN = 3 => SET EXEC ADDR
;     FN = 4 => SET ACCESS BYTE
;     FN = 5 => SET DATE
;ARGH +n (depending on ARGF) = ATTRIBUTES TO SET

;EXIT : ARGA = RC


;FORMAT OF ACCESS BYTE:-

;BIT0->PUBLIC HAS READ ACCESS
;BIT1->PUBLIC HAS WRITE ACCESS
;BIT2->OWNER HAS READ ACCESS
;BIT3->OWNER HAS WRITE ACCESS
;BIT4->ENTRY IS LOCKED

DRSAT1 = DRLOAD ;Offsets in directory entry
 = DRLOAD
 = DREXEC
 = DRACCS
 = DRDATE

DRSAT2 =  9 ;Length of data
 =  4
 =  4
 =  1
 =  2

DRSACC ROUT
 STZ DMTEMP+2 ;save space for Access arg
 LDYIM ARGF
 LDAIY ARGPTR
 STA DIRWC ;get wild card flag
 JSR INITDV ;INITIALISE VARIABLES
 BNE #50

 LDYIM ARGG ;CHECK IF JUST DATE UPDATE
 LDAIY ARGPTR
 CMPIM 5
 BEQ #10 ;NO NEED FOR OWNER ACCESS

;CHECK FOR OWNER ACCESS

 JSR TSTOWN
 BNE #50

;RETRIEVE APPROPRIATE DIR ENTRY

10 JSR RETENT
 BNE #50

20 LDYIM ARGG
 LDAIY ARGPTR
 STA DMTEMP+1 ;Store for later
 LDYIM ARGH ;Position of access if A=4
 CMPIM 4 ;If SETACCESS, must mask off access bits
 BEQ #25 ;Is SETACCESS -> check access byte
 CMPIM 5 ;** 31/1/85 **
 BEQ #55
 CMPIM 1
 BNE #40 ;Is "all attribs" so check access
 LDYIM ARGP ;Position of access if A = 1

25 STY DMTEMP ;Store offset of access
 LDAIY ARGPTR ;Read access byte
 ANDIM ACCMSK ;Mask off access bits
 ORA DMTEMP+2
 STA DMTEMP+2
 STAIY ARGPTR
 TAX  ;Store for later

;** 15/11/84 ** w/ access illegal
 ANDIM &0C ;owner bits set
 BEQ #35
 ANDIM &04 ;at least r bit set
 BNE #35
 LDAIM SAERRA ;'bad attribute' error
 BRA #45

35 JSR ISDIR
 BNE #55 ;Is not a directory, so continue
 TXA
 ANDIM ACCMSK-RWMSK ;just the lock bit
 ORAIM TYPDIR ;Or in directory info. if a dir. 
 LDY DMTEMP
 STAIY ARGPTR ;Stuff access argument
 LDA DMTEMP+1 ;Load function no.
 CMPIM 1
 BNE #55 ;Check not setting load/exec. of a dir.

40 JSR ISDIR ;Check if is directory
 BNE #55 ;Cannot set load/exec address of dir., so error
 LDAIM DRERRF ;Bad arg.

45 JSR UNLOCK ;Otherwise, error
50 BRA #65 ;Error exit

55 LDYIM ARGG ;Here, all checks made, so set attribs
 LDAIY ARGPTR 
 TAY
 LDAIM ARGH ;Set args for block move from stack
 STA OFF1 ;to some offset in CRNTEN
 LDAAY DRSAT1-1 ;Get offset in dir. entry
 STA OFF2 ;"Move to" offset
 LDAAY DRSAT2-1 ;Length to move
 LDXIM ARGPTR ;"Move from" ptr.
 LDYIM CRNTEN ;"Move to" ptr.
 JSR MOVBLK ;Move args to stack

 LDYIM ARGG
 LDAIY ARGPTR
 CMPIM 5 ;DON'T SET ALL DATES
 BEQ #60

 JSR FNDTEZ ;try for any more entries
 BNE #60
 JMP #20

60 JSR ENSRIT ;Ensure directory and exit

65 JMP DREXIT ;**25/12/86**



;************ DRCRDR ************


;DRCRDR: CREATE & PRESERVE A NEW DIRECTORY

;ENTRY:
;ARGB-C PTR TO USERINFO
;ARGD-E PTR TO FILE TITLE
;ARGF = Size of directory ** 15/9/83 **
;ARGG = Wild card flag

;EXIT :
;ARGA = RC
;ARGB-C DISC NO
;ARGD-F SIN OF OBJECT TO BE DELETED

DRCRDR ROUT
 LDYIM ARGG
 LDAIY ARGPTR
 STA DIRWC ;get wild card flag
 JSR INITDV
 BNE #40

;CHECK FOR OWNER ACCESS

 JSR TSTOWN
 BNE #40

;Load parent directory and save SIN  **23/1/87**

 JSR RETDIR
 BNE #40
 LDA DIRSIN
 STA EXRTN
 LDA DIRSIN+1
 STA EXRTN+1
 LDA DIRSIN+2
 STA EXRTN+2
 JSR UNLOCK ;release parent pro tem
 JSR TSTPAR ;prohibit new name of "^"
 BEQ #50
 [ Pseudods = Yes
 LDYIM 0 ;**20/5/87** prohibit new names of "&", "%", "@"
 LDAIY NAMPTR
 JSR Testpd
 BNE #15
 JSR TSTTER
 BEQ #50
 ]
15 LDYIM ARGG
 LDAIY ARGPTR
 STA DIRWC ;**24/7/87** get wild card flag again
 JSR INITDV ;reinitialise variables
 BNE #40

;CREATE A VIRGIN DIRECTORY

 LDYIM ARGF
 LDAIY ARGPTR
 STA DIRTMP+1 ;DIRTMP := SIZE OF DIRECTORY REQD.
 STZ DIRTMP
 STZ DIRTMP+2
 JSR MAKDIR ;SETUP ARGPTR ARGUMENTS FOR DIRMAN.PRESERVE
 BNE #40

;NOW UNLOCK THE CREATED DIR - THE RETAIN RTN
;ENSURES THAT ITS UPTO DATE ON DISC

 JSR UNLOCK

;NOW HAVE IT RETAINED

 JSR INITDV ;REINITIALISE VARIABLES
 BEQ #30

20  ;OBJSIN:=SIN OF NEW DIR(RETAIN DESTROYS OBJSIN)
 JSR DELOBJ ;**** 17/3/83 ****
 BRA #40

;LOAD APPROPRATE DIR

30 JSR RETDIR
 BNE #20

;NOW HAVE IT RETAINED IN THIS DIR

 JSR RETAIN
 BNE #20
40 JMP DREXIT

50 LDAIM DRERRA ;Can't use name "^"
 BRA #40


 LNK UADE0CA
